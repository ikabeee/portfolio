---
import type { Project } from "../interfaces/Project";
import Badge from "./Badge.astro";
import APICon from "./icons/general/APICon.astro";
import ComponentIcon from "./icons/general/ComponentIcon.astro";
import DropdownArrow from "./icons/general/DropdownArrow.astro";
import Mobile from "./icons/general/Mobile.astro";
import WebIcon from "./icons/general/WebIcon.astro";

interface Props extends Project {}
const { title, duration, img, description, alt, codeSource, technologies, objects } =
  Astro.props;

const images: string[] = (objects && objects.length > 0) ? objects : [img];

const modalId = `modal-${title.replace(/\s+/g, "-").toLowerCase()}`;
---

<div class="card bg-base-300 shadow-lg card-compact md:card-side">
  <figure
    class="w-full md:w-64 lg:w-72 h-48 md:h-64 lg:h-72 flex-shrink-0 overflow-hidden cursor-pointer relative group"
    data-modal-id={modalId}
    data-images={JSON.stringify(images)}
  >
    <img
      src={images[0]}
      alt={alt}
      class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-300"
    />
  </figure>

  <div class="card-body p-3 sm:p-4 md:p-5 lg:p-6 flex flex-col">
    <!-- Header: Título y Duración -->
    <div
      class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2 mb-2"
    >
      <h2
        class="card-title text-base sm:text-lg md:text-xl lg:text-2xl leading-tight"
      >
        {title}
      </h2>
      <div class="self-start sm:self-auto">
        <Badge size="sm" label={duration} icon={null} />
      </div>
    </div>

    <!-- Descripción - Flex grow para ocupar espacio disponible -->
    <p
      class="text-xs sm:text-sm md:text-base leading-relaxed mb-3 sm:mb-4 flex-grow"
    >
      {description}
    </p>

    <!-- Footer: Tecnologías y Botón en el borde inferior -->
    <div
      class="flex flex-col sm:flex-row sm:justify-between sm:items-end gap-3 mt-auto"
    >
      <!-- Tecnologías -->
      <div class="flex flex-wrap gap-1 sm:gap-2 flex-1 min-w-0">
        {
          technologies.map((tech) => (
            <Badge
              key={tech.name}
              size="sm"
              label={tech.name}
              icon={tech.icon}
            />
          ))
        }
      </div>

      <!-- Botón -->
      <div class="flex-shrink-0 self-end">
        <div class="dropdown dropdown-bottom sm:dropdown-end">
          <div
            tabindex="0"
            role="button"
            class="btn btn-xs sm:btn-sm bg-[#569CDE] text-white hover:bg-[#4A9CE8] border-none text-xs sm:text-sm"
          >
            <ComponentIcon class="w-3 h-3 sm:w-4 sm:h-4" />
            <span class="hidden xs:inline sm:inline">Código</span>
            <span class="xs:hidden sm:hidden">Ver</span>
            <DropdownArrow class="w-3 h-3 sm:w-4 sm:h-4" />
          </div>
          <ul
            tabindex="0"
            class="dropdown-content z-[1] menu p-2 shadow-lg bg-[#569CDE] rounded-box w-44 sm:w-52 text-white text-xs sm:text-sm"
          >
            <!-- API Repository -->
            {
              (codeSource.api && codeSource.api !== "No disponible") ? (
                <li>
                  <a
                    href={codeSource.api}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-white hover:bg-[#4A9CE8] transition-colors duration-200 p-2"
                  >
                    <APICon class="w-3 h-3 sm:w-4 sm:h-4" />
                    <span class="truncate">API</span>
                  </a>
                </li>
              ) : (
                <li>
                  <div class="p-2 flex items-center gap-2 text-white opacity-60 cursor-not-allowed">
                    <APICon class="w-3 h-3 sm:w-4 sm:h-4" />
                    <span class="truncate">API — No disponible</span>
                  </div>
                </li>
              )
            }

            <!-- Web Repository -->
            {
              (codeSource.web && codeSource.web !== "No disponible") ? (
                <li>
                  <a
                    href={codeSource.web}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-white hover:bg-[#4A9CE8] transition-colors duration-200 p-2"
                  >
                    <WebIcon class="w-3 h-3 sm:w-4 sm:h-4" />
                    <span class="truncate">Web</span>
                  </a>
                </li>
              ) : (
                <li>
                  <div class="p-2 flex items-center gap-2 text-white opacity-60 cursor-not-allowed">
                    <WebIcon class="w-3 h-3 sm:w-4 sm:h-4" />
                    <span class="truncate">Web — No disponible</span>
                  </div>
                </li>
              )
            }

            {
              (codeSource.mobile && codeSource.mobile !== "No disponible") ? (
                <li>
                  <a
                    href={codeSource.mobile}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-white hover:bg-[#4A9CE8] transition-colors duration-200 p-2"
                  >
                    <Mobile class="w-3 h-3 sm:w-4 sm:h-4" />
                    <span class="truncate">Móvil</span>
                  </a>
                </li>
              ) : (
                // Si no hay mobile, no renderizamos nada para mantener el menú limpio
                null
              )
            }
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal personalizado con divs -->
<div 
  id={modalId} 
  class="fixed inset-0 backdrop-blur-md bg-opacity-50 flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300 ease-in-out"
>
  <!-- Backdrop clickeable -->
  <div class="absolute inset-0" data-close-modal={modalId}></div>
  
  <!-- Modal content -->
  <div class="bg-base-200 rounded-lg shadow-xl max-w-5xl w-11/12 max-h-[90vh] relative transform scale-90 transition-transform duration-300 ease-in-out">
    <!-- Botón de cerrar -->
    <button 
      type="button"
      class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 z-10"
      data-close-modal={modalId}
    >
      ✕
    </button>
    
    <div class="p-6 flex flex-col gap-4">
      <!-- Título del proyecto en el modal -->
      <h3 class="font-bold text-lg text-center">{title}</h3>

      <!-- Galería / Imagen principal -->
      <div class="flex flex-col items-center gap-3">
        <div class="relative w-full flex justify-center">
          <button type="button" class="absolute left-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-sm" data-gallery-prev={modalId} aria-label="Anterior">◀</button>
          <img
            id={`modal-img-${modalId}`}
            src={images[0]}
            alt={alt}
            class="max-w-full max-h-[70vh] object-contain rounded-lg shadow-lg"
          />
          <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-sm" data-gallery-next={modalId} aria-label="Siguiente">▶</button>
        </div>

        <!-- Thumbnails -->
        <div class="flex gap-2 overflow-x-auto py-2" id={`modal-thumbs-${modalId}`}>
          {
            images.map((src, idx) => (
              <button type="button" class="rounded-md overflow-hidden border-2 border-transparent" data-thumb-index={idx} data-thumb-modal={modalId}>
                <img src={src} alt={`${title} thumb ${idx + 1}`} class="w-20 h-12 object-cover" />
              </button>
            ))
          }
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Función para abrir modal
    function openModal(modalId: string): void {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('opacity-0', 'invisible');
        modal.classList.add('opacity-100', 'visible');
        const content = modal.querySelector('.transform') as HTMLElement;
        if (content) {
          content.classList.remove('scale-90');
          content.classList.add('scale-100');
        }

        try {
          const trigger = document.querySelector(`[data-modal-id="${modalId}"]`) as HTMLElement | null;
          const triggerData = trigger ? trigger.getAttribute('data-images') : null;

          if (triggerData) {
            modal.setAttribute('data-images', triggerData);
          }

          const dataImages = modal.getAttribute('data-images');
          const images = dataImages ? JSON.parse(dataImages) : null;
          if (images && images.length > 0) {
            modal.dataset.currentIndex = '0';
            const mainImg = modal.querySelector(`#modal-img-${modal.id}`) as HTMLImageElement;
            if (mainImg) mainImg.src = images[0];
            // mark first thumb active
            const thumbs = modal.querySelectorAll(`[data-thumb-modal="${modal.id}"]`);
            thumbs.forEach((t) => t.classList.remove('ring-2', 'ring-[#569CDE]'));
            if (thumbs[0]) thumbs[0].classList.add('ring-2', 'ring-[#569CDE]');
          }
        } catch (err) {
          // ignore parse errors
        }

        document.body.style.overflow = 'hidden'; 
      }
    }

    // Función para cerrar modal
    function closeModal(modalId: string): void {
      const modal = document.getElementById(modalId);
      if (modal) {
        const content = modal.querySelector('.transform') as HTMLElement;
        if (content) {
          content.classList.remove('scale-100');
          content.classList.add('scale-90');
        }
        modal.classList.remove('opacity-100', 'visible');
        modal.classList.add('opacity-0', 'invisible');
        document.body.style.overflow = '';
      }
    }

    // Event listeners para abrir modales
    const modalTriggers = document.querySelectorAll('[data-modal-id]');
    modalTriggers.forEach((trigger) => {
      trigger.addEventListener('click', function(e: Event) {
        e.preventDefault();
        e.stopPropagation();
        const target = e.currentTarget as HTMLElement;
        const modalId = target.getAttribute('data-modal-id');
        if (modalId) {
          openModal(modalId);
        }
      });
    });


    const closeButtons = document.querySelectorAll('[data-close-modal]');
    closeButtons.forEach((button) => {
      button.addEventListener('click', function(e: Event) {
        e.preventDefault();
        e.stopPropagation();
        const target = e.currentTarget as HTMLElement;
        const modalId = target.getAttribute('data-close-modal');
        if (modalId) {
          closeModal(modalId);
        }
      });
    });

    document.querySelectorAll('[data-gallery-prev]').forEach((btn) => {
      btn.addEventListener('click', function(e: Event) {
        const modalId = (e.currentTarget as HTMLElement).getAttribute('data-gallery-prev');
        if (!modalId) return;
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const dataImages = modal.getAttribute('data-images');
        if (!dataImages) return;
        const images = JSON.parse(dataImages);
        let idx = parseInt(modal.dataset.currentIndex || '0', 10);
        idx = (idx - 1 + images.length) % images.length;
        modal.dataset.currentIndex = String(idx);
        const mainImg = modal.querySelector(`#modal-img-${modalId}`) as HTMLImageElement;
        if (mainImg) mainImg.src = images[idx];
        // update thumbs
        const thumbs = modal.querySelectorAll(`[data-thumb-modal="${modalId}"]`);
        thumbs.forEach((t) => t.classList.remove('ring-2', 'ring-[#569CDE]'));
        const active = modal.querySelector(`[data-thumb-modal="${modalId}"][data-thumb-index="${idx}"]`);
        if (active) active.classList.add('ring-2', 'ring-[#569CDE]');
      });
    });

    document.querySelectorAll('[data-gallery-next]').forEach((btn) => {
      btn.addEventListener('click', function(e: Event) {
        const modalId = (e.currentTarget as HTMLElement).getAttribute('data-gallery-next');
        if (!modalId) return;
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const dataImages = modal.getAttribute('data-images');
        if (!dataImages) return;
        const images = JSON.parse(dataImages);
        let idx = parseInt(modal.dataset.currentIndex || '0', 10);
        idx = (idx + 1) % images.length;
        modal.dataset.currentIndex = String(idx);
        const mainImg = modal.querySelector(`#modal-img-${modalId}`) as HTMLImageElement;
        if (mainImg) mainImg.src = images[idx];
        // update thumbs
        const thumbs = modal.querySelectorAll(`[data-thumb-modal="${modalId}"]`);
        thumbs.forEach((t) => t.classList.remove('ring-2', 'ring-[#569CDE]'));
        const active = modal.querySelector(`[data-thumb-modal="${modalId}"][data-thumb-index="${idx}"]`);
        if (active) active.classList.add('ring-2', 'ring-[#569CDE]');
      });
    });

    // Thumbnail clicks
    document.addEventListener('click', function(e: Event) {
      const target = e.target as HTMLElement;
      const thumb = target.closest('[data-thumb-index]') as HTMLElement | null;
      if (!thumb) return;
      const modalId = thumb.getAttribute('data-thumb-modal');
      const idx = Number(thumb.getAttribute('data-thumb-index'));
      if (!modalId || isNaN(idx)) return;
      const modal = document.getElementById(modalId);
      if (!modal) return;
      const dataImages = modal.getAttribute('data-images');
      if (!dataImages) return;
      const images = JSON.parse(dataImages);
      modal.dataset.currentIndex = String(idx);
      const mainImg = modal.querySelector(`#modal-img-${modalId}`) as HTMLImageElement;
      if (mainImg) mainImg.src = images[idx];
      const thumbs = modal.querySelectorAll(`[data-thumb-modal="${modalId}"]`);
      thumbs.forEach((t) => t.classList.remove('ring-2', 'ring-[#569CDE]'));
      thumb.classList.add('ring-2', 'ring-[#569CDE]');
    });

    // Cerrar modal con ESC
    document.addEventListener('keydown', function(e: KeyboardEvent) {
      if (e.key === 'Escape') {
        const visibleModal = document.querySelector('.fixed[id^="modal-"]:not(.invisible)') as HTMLElement;
        if (visibleModal) {
          const modalId = visibleModal.id;
          closeModal(modalId);
        }
      }
    });
  });
</script>
